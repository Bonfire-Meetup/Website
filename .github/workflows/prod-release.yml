name: Production Release

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: prod-release
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  build_migrate_deploy:
    name: Build → Migrate → Deploy (Vercel prebuilt) → Verify
    runs-on: blacksmith-2vcpu-ubuntu-2404
    timeout-minutes: 25
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install deps
        run: bun install --frozen-lockfile

      - name: Quality check
        run: bun run check

      - name: Compute build version
        run: |
          v="${GITHUB_SHA::12}"
          echo "NEXT_PUBLIC_BNF_VERSION=$v" >> "$GITHUB_ENV"

      - name: Vercel pull project settings (prod)
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          set -euo pipefail
          bunx vercel@latest pull --yes --environment=production --token="$VERCEL_TOKEN"

      - name: Vercel build (prod) → .vercel/output
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

          NEXT_PUBLIC_BNF_VERSION: ${{ env.NEXT_PUBLIC_BNF_VERSION }}
          BNF_VERSION: ${{ env.NEXT_PUBLIC_BNF_VERSION }}

          BNF_NEON_DATABASE_URL: ${{ secrets.BNF_NEON_DATABASE_URL }}
          BNF_HEARTS_SALT: ${{ secrets.BNF_HEARTS_SALT }}
          BNF_CHECKIN_SECRET: ${{ secrets.BNF_CHECKIN_SECRET }}
          BNF_TURNSTILE_SECRET_KEY: ${{ secrets.BNF_TURNSTILE_SECRET_KEY }}
          NEXT_PUBLIC_BNF_TURNSTILE_SITE_KEY: ${{ secrets.NEXT_PUBLIC_BNF_TURNSTILE_SITE_KEY }}
          BNF_RESEND_API_KEY: ${{ secrets.BNF_RESEND_API_KEY }}
          BNF_RESEND_FROM: ${{ secrets.BNF_RESEND_FROM }}
          BNF_RESEND_AUTH_FROM: ${{ secrets.BNF_RESEND_AUTH_FROM }}
          BNF_OTP_SECRET: ${{ secrets.BNF_OTP_SECRET }}
          BNF_JWT_PRIVATE_KEY: ${{ secrets.BNF_JWT_PRIVATE_KEY }}
          BNF_JWT_PUBLIC_KEY: ${{ secrets.BNF_JWT_PUBLIC_KEY }}
          BNF_JWT_ISSUER: ${{ secrets.BNF_JWT_ISSUER }}
          BNF_JWT_AUDIENCE: ${{ secrets.BNF_JWT_AUDIENCE }}
          BNF_JWT_KEY_ID: ${{ secrets.BNF_JWT_KEY_ID }}
          BNF_LOG_SALT: ${{ secrets.BNF_LOG_SALT }}
          BNF_WEBAUTHN_RP_ID: ${{ secrets.BNF_WEBAUTHN_RP_ID }}
          BNF_WEBAUTHN_RP_NAME: ${{ secrets.BNF_WEBAUTHN_RP_NAME }}
          BNF_WEBAUTHN_ORIGIN: ${{ secrets.BNF_WEBAUTHN_ORIGIN }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
          BNF_ROLLBAR_SERVER_TOKEN: ${{ secrets.BNF_ROLLBAR_SERVER_TOKEN }}
          NEXT_PUBLIC_BNF_ROLLBAR_CLIENT_TOKEN: ${{ secrets.NEXT_PUBLIC_BNF_ROLLBAR_CLIENT_TOKEN }}
        run: |
          set -euo pipefail
          bunx vercel@latest build --prod --token="$VERCEL_TOKEN"

      - name: Run Drizzle migrations (prod)
        env:
          BNF_NEON_DATABASE_URL: ${{ secrets.BNF_NEON_DATABASE_URL_PROD }}
        run: |
          set -euo pipefail
          test -n "$BNF_NEON_DATABASE_URL"
          bunx drizzle-kit migrate 2>&1 | tee drizzle-migrate.log

      - name: Vercel deploy prebuilt (prod)
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          bunx vercel@latest deploy --prebuilt --prod --token="$VERCEL_TOKEN"

      - name: Smoke check (health + exact version)
        env:
          PROD_URL: ${{ vars.PROD_URL }}
          EXPECTED_VERSION: ${{ env.NEXT_PUBLIC_BNF_VERSION }}
        run: |
          set -euo pipefail
          test -n "$PROD_URL"
          test -n "$EXPECTED_VERSION"

          body="$(curl --fail --silent --show-error --retry 10 --retry-delay 3 "$PROD_URL/api/health")"
          echo "$body"
          echo "$body" | grep -F "\"version\":\"$EXPECTED_VERSION\""

      - name: Upload logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: prod-release-debug
          path: |
            drizzle-migrate.log
            .vercel/output
          if-no-files-found: ignore
